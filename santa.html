# To run this code you need to install the following dependencies:
# pip install google-genai

import base64
import mimetypes
import os
import re
import struct
from google import genai
from google.genai import types


def save_binary_file(file_name, data):
    f = open(file_name, "wb")
    f.write(data)
    f.close()
    print(f"File saved to to: {file_name}")


def generate():
    client = genai.Client(
        api_key=os.environ.get("GEMINI_API_KEY"),
    )

    model = "gemini-2.5-pro-preview-tts"
    contents = [
        types.Content(
            role="user",
            parts=[
                types.Part.from_text(text="""Speaker 1: Ho! Ho! Hoooo000oo! Oh god that's a relief. Better out than in, am I right, doc?
Speaker 2: Oh. Oh! Maybe I should light a candle.
Speaker 1: Better to just open a window for a minute. Let it clear out. Damn stuff is flammable and in an enclosed space like this- BOOM!
Speaker 2: These windows don't open for security, maybe-
Speaker 1: Believe it or not, you get used to it.
Speaker 2: Do you mind if I open the door, just a crack?
Speaker 1: Sure thing! Share the air! Give the other crazies a sniff.
Speaker 2: Crazy is not a term we care for here. This is a place of healing.
Speaker 1: It's not my fault.
Speaker 2: I'm not here to judge or fault anyone.
Speaker 1: No. I mean the gas. Whew! That was a strong one. Almost has a color.
Speaker 2: High levels of stress can trigger-
Speaker 1: No. No. I mean yeah stress but it's all the goddamn milk. Milk and cookies. I'm lactose intolerant ya see? Always have been. And what do they leave out? Big glasses of milk.
Speaker 2: There are over the counter medications.
Speaker 1: I mean the cool houses put out a couple fat fingers of brandy or whisky. Those houses, they're all right!
Speaker 2: But if you're driving, your ummm, sleigh should you really be having alcohol?
Speaker 1: Oh the reindeer do the driving. The reins are just for show. Except for Prancer and Blitzen. Fuckers are kinky as hell. The whip, harnesses. It's all for them. They're chomping at the bit.
Speaker 2: It's actually champing. Champing at the bit. Chomping means to chew. Champing is to pull eagerly.
Speaker 1: That's them all right. Eager. Did you know all reindeer are bisexual?
Speaker 2: I did not.
Speaker 1: If I don't get the bells off of them fast enough, sounds like the world's largest cocktail shaker filled with wind chimes and loose change. Jingle hell reindeer orgy.
Speaker 2: And how does that make you feel?
Speaker 1: Rudolph's fixated on oral. Gets that goddamn nose so far up there- Vixen, Comet, Cupid, they light up from the inside.
Speaker 2: That must appear unusual.
Speaker 1: It's pretty ghastly really, like seeing a blood red x-ray. All their organs and bones. Did you know elves only have one kidney?
Speaker 2: The elves too...
Speaker 1: Oh yeah. Elves are up for anything.
Speaker 2: And do you feel marginalized from your community?
Speaker 1: Me? Oh hell no. All those cold nights up at the pole. We're all stuffing each others stockings in just about every combination you can imagine.
Speaker 2: Are you worried you might have a sex addiction?
Speaker 1: Gotta watch out for Donner though. He bites.
Speaker 2: How does this affect your relationship with Mrs. Clause?
Speaker 1: Seriously?
Speaker 2: Home. Career. Friends. Romantic partner- they're all pillars of how the world supports the self.
Speaker 1: Doc. She runs a factory. Loves tools? No kids? Active in social causes?
Speaker 2: Are you struggling with fertility?
Speaker 1: Fuck no. At last I don't think so. I mean, that song, I saw Mommy kissing Santa Claus?
Speaker 2: I don't follow.
Speaker 1: I've been leaving the old nut nog around the world for so many years, like half the world's population growth is due to me. Wait! Ho! Ho!...Oh! OH! oh.
Speaker 2: Maybe I can find a fan.
Speaker 1: Nope. False alarm. Damn. Builds up and I get cramps.
Speaker 2: I can give you a referral to a gastro specialist.
Speaker 1: Nah. Don't worry about it. I had Rudolph ram his snout up there for the ol' Christmas Colonoscopy. Believe it or not, this isn't jelly or even fat. It's bloat.
Speaker 2: Not really my specialty. You were telling me about your relationship with Mrs. Claus.
Speaker 1: Doc! She drives a Subaru. Covered in bumper stickers. Like a TON of bumper stickers.
Speaker 2: Over-reliance on non-verbal communication can be an indicator of-
Speaker 1: She goes to vegan potlucks where they sit around and read from their journals. I gotta spell this out? Talk to me about estranged after you've gone balls deep in a reindeer while simultaneously eating frosting out of a Wisconsin housewife and being fisted by an elf. That's estranged!
Speaker 2: Why are you using vulgarity as a defense mechanism?
Speaker 1: It really happened!
Speaker 2: And saying anything to avoid the real reason why you're here.
Speaker 1: Elves have surprisingly large hands by the way.
Speaker 2: Mr. Claus.
Speaker 1: You know I had to go to court once to stay out of a place like this.
Speaker 2: Are you referring to Miracle on 34th Street? In that movie, and I emphasize it was a movie, Santa was proving his existence. That he was real. Do you sometimes feel unreal?
Speaker 1: Two movies. There was a remake in 1994. You ever seen Harvey? It was Jimmy Stewart but yeah. I fucked him. No. The rabbit. I poked the pooka then the pooka poked me.
Speaker 2: You're here voluntarily but you seem really resistant to talk about why.
Speaker 1: I'm the last one. The last Christmas spirit. The last one that matters anyway.
Speaker 2: Tell me more about that.
Speaker 1: Father Christmas got bought out by Coca-Cola. I mean I get it, the Brits were flat broke after World War two.
Speaker 2: So you're not all the same...entity?
Speaker 1: Nope. Saint Nicholas was Turkish and got listed as an opposition figure by Erdoğan. Nobody has seen him since.
Speaker 2: What about Good King Wenceslas? Kris Kringle?
Speaker 1: The KGB nabbed Wenceslas during the Prague Spring of sixty-eight. I told him to stay out of it. Kringle is still under copyright by Universal.
Speaker 2: I thought those clay-mations were made by Rankin-Bass.
Speaker 1: They were. Bought by Dreamworks. Acquired by Universal, part of NBC Universal which is a wholly owned subsidiary of Comcast. Consolidation of ...everything.
Speaker 2: You sound like you're feeling pretty lonely.
Speaker 1: The Italian Christmas witch Befana retired. Anyway, Joulupukki is the Finnish Christmas goat. He, some of my spare reindeer, and La Loba-
Speaker 2: Ah, the Mexican mother wolf.
Speaker 1: The very same. They all ran off and joined some cult that believes in UFOs. Crazy.
Speaker 2: We don't use the word crazy here.
Speaker 1: Then there's the Welsh horse skull thing, Mari Lwyd, and Krampus, as well as a bunch of trolls and goblins and all that bullshit for the goth kids. But just try caroling to Depeche Mode- Head like a hole. Black as your soul. I'd rather die-
Speaker 2: That's Nine Inch Nails.
Speaker 1: Like that's any better.
Speaker 2: Point. Surely there must be somebody else left. Some other avatar of Christmas? Elf on a shelf?
Speaker 1: Doc. All the way up to the elbow. If people knew half the shit elves are into...
Speaker 2: So you believe you're the last true holiday spirit?
Speaker 1: Christian one anyway. I mean I guess in Spain they have Caga Tió.
Speaker 2: I'm not familiar.
Speaker 1: It's literally a log. Families wrap it in a blanket and feed it table scraps then, on Christmas, they beat it with a stick like a piñata until it poops out candy.
Speaker 2: That does not sound healthy.
Speaker 1: Maybe I should try that. See if I could blow out some of this pressure. Got a stick?
Speaker 2: I've got it! Saint Lucia! The Scandinavian countries. Crown of candles?
Speaker 1: Doc. Doc. Doc. We already talked about the dangers of open flame. Hair product. Candles. Poof. Head went up like a dry tree. And kids saw that shit. Natten går tung- AAAAH! AAAAAAH!
Speaker 2: That must have-
Speaker 1: AAAAAAHHHHHH! Smell of lingon berry and burning hair!
Speaker 2: This explains a lot.
Speaker 1: Won't find that in IKEA.
Speaker 2: I might need to consult the medical journals.
Speaker 1: Do you think teaching kids to beat a log until candy sprays out is a metaphor for masturbation?
Speaker 2: I don't know. I really don't.
Speaker 1: Because that's really fucked up. We should call somebody.
Speaker 2: Yes. Yes we should.
Speaker 1: I'm not sure who. Can you report a whole country? Hello, UN? EU? I'd like to report Spain.
Speaker 2: Somebody in Brussels maybe.
Speaker 1: Course I'm not one to talk. Run a blacklight over the interior of my sleigh and you would even say it glows.
Speaker 2: I'm really glad, really glad you've chosen to prioritize self-care and check yourself in. There's a lot...This is a lot.
Speaker 1: Yeah. It's time I did something for me.
Speaker 2: Past time.
Speaker 1: Nobody really wants me anymore anyway. The fuckers in Indiana will shoot you for coming up the front walk, imagine just appearing in their living room.
Speaker 2: Definitely dangerous.
Speaker 1: I mean my suit is Kevlar but still. And, Texans all think I'm some kind of communist. Course they take the free toys anyway.
Speaker 2: It's really, really good you're here.
Speaker 1: So what do you think?
Speaker 2: In-patient intensive. Twenty-four seven monitoring. Therapy. All the therapies. Individual. Group. Electro-convulsive. Pharmacological.
Speaker 1: Like drugs? Say, you're all right.
Speaker 2: Let's get started on your intake right away. Who do you have for insurance? Insurance? Or maybe Medicare? Medicaid? You are a US citizen?
Speaker 1: No... Not per se... Wait! Ho...Ho!...."""),
            ],
        ),
    ]
    generate_content_config = types.GenerateContentConfig(
        temperature=1,
        response_modalities=[
            "audio",
        ],
        speech_config=types.SpeechConfig(
            multi_speaker_voice_config=types.MultiSpeakerVoiceConfig(
                speaker_voice_configs=[
                    types.SpeakerVoiceConfig(
                        speaker="Speaker 1",
                        voice_config=types.VoiceConfig(
                            prebuilt_voice_config=types.PrebuiltVoiceConfig(
                                voice_name="Fenrir"
                            )
                        ),
                    ),
                    types.SpeakerVoiceConfig(
                        speaker="Speaker 2",
                        voice_config=types.VoiceConfig(
                            prebuilt_voice_config=types.PrebuiltVoiceConfig(
                                voice_name="Aoede"
                            )
                        ),
                    ),
                ]
            ),
        ),
    )

    file_index = 0
    for chunk in client.models.generate_content_stream(
        model=model,
        contents=contents,
        config=generate_content_config,
    ):
        if (
            chunk.candidates is None
            or chunk.candidates[0].content is None
            or chunk.candidates[0].content.parts is None
        ):
            continue
        if chunk.candidates[0].content.parts[0].inline_data and chunk.candidates[0].content.parts[0].inline_data.data:
            file_name = f"ENTER_FILE_NAME_{file_index}"
            file_index += 1
            inline_data = chunk.candidates[0].content.parts[0].inline_data
            data_buffer = inline_data.data
            file_extension = mimetypes.guess_extension(inline_data.mime_type)
            if file_extension is None:
                file_extension = ".wav"
                data_buffer = convert_to_wav(inline_data.data, inline_data.mime_type)
            save_binary_file(f"{file_name}{file_extension}", data_buffer)
        else:
            print(chunk.text)

def convert_to_wav(audio_data: bytes, mime_type: str) -> bytes:
    """Generates a WAV file header for the given audio data and parameters.

    Args:
        audio_data: The raw audio data as a bytes object.
        mime_type: Mime type of the audio data.

    Returns:
        A bytes object representing the WAV file header.
    """
    parameters = parse_audio_mime_type(mime_type)
    bits_per_sample = parameters["bits_per_sample"]
    sample_rate = parameters["rate"]
    num_channels = 1
    data_size = len(audio_data)
    bytes_per_sample = bits_per_sample // 8
    block_align = num_channels * bytes_per_sample
    byte_rate = sample_rate * block_align
    chunk_size = 36 + data_size  # 36 bytes for header fields before data chunk size

    # http://soundfile.sapp.org/doc/WaveFormat/

    header = struct.pack(
        "<4sI4s4sIHHIIHH4sI",
        b"RIFF",          # ChunkID
        chunk_size,       # ChunkSize (total file size - 8 bytes)
        b"WAVE",          # Format
        b"fmt ",          # Subchunk1ID
        16,               # Subchunk1Size (16 for PCM)
        1,                # AudioFormat (1 for PCM)
        num_channels,     # NumChannels
        sample_rate,      # SampleRate
        byte_rate,        # ByteRate
        block_align,      # BlockAlign
        bits_per_sample,  # BitsPerSample
        b"data",          # Subchunk2ID
        data_size         # Subchunk2Size (size of audio data)
    )
    return header + audio_data

def parse_audio_mime_type(mime_type: str) -> dict[str, int | None]:
    """Parses bits per sample and rate from an audio MIME type string.

    Assumes bits per sample is encoded like "L16" and rate as "rate=xxxxx".

    Args:
        mime_type: The audio MIME type string (e.g., "audio/L16;rate=24000").

    Returns:
        A dictionary with "bits_per_sample" and "rate" keys. Values will be
        integers if found, otherwise None.
    """
    bits_per_sample = 16
    rate = 24000

    # Extract rate from parameters
    parts = mime_type.split(";")
    for param in parts: # Skip the main type part
        param = param.strip()
        if param.lower().startswith("rate="):
            try:
                rate_str = param.split("=", 1)[1]
                rate = int(rate_str)
            except (ValueError, IndexError):
                # Handle cases like "rate=" with no value or non-integer value
                pass # Keep rate as default
        elif param.startswith("audio/L"):
            try:
                bits_per_sample = int(param.split("L", 1)[1])
            except (ValueError, IndexError):
                pass # Keep bits_per_sample as default if conversion fails

    return {"bits_per_sample": bits_per_sample, "rate": rate}


if __name__ == "__main__":
    generate()
